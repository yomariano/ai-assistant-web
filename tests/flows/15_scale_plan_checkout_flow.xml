<?xml version="1.0" encoding="UTF-8"?>
<testFlow id="scale_plan_checkout_flow" version="1.0">
  <metadata>
    <name>Scale/Pro Plan Checkout Flow</name>
    <description>Tests the complete checkout flow for the Pro/Scale plan at EUR 249/month with unlimited calls</description>
    <priority>high</priority>
    <estimatedDuration>4m</estimatedDuration>
    <tags>
      <tag>checkout</tag>
      <tag>stripe</tag>
      <tag>scale-plan</tag>
      <tag>enterprise</tag>
      <tag>eur</tag>
    </tags>
  </metadata>

  <prerequisites>
    <prerequisite>Stripe test mode enabled</prerequisite>
    <prerequisite>Payment links configured in environment</prerequisite>
  </prerequisites>

  <testData>
    <variable name="baseUrl" value="https://voicefleet.ai" />
    <variable name="planName" value="Pro" />
    <variable name="planPrice" value="249" />
    <variable name="testCard" value="4242424242424242" />
    <variable name="testExpiry" value="12/34" />
    <variable name="testCvc" value="123" />
  </testData>

  <steps>
    <step id="1" type="navigation">
      <action>Navigate to pricing section</action>
      <url>${baseUrl}/#pricing</url>
      <expectedResult>
        <condition type="elementVisible">Pricing cards</condition>
      </expectedResult>
    </step>

    <step id="2" type="verification">
      <action>Verify Pro plan details and unlimited calls</action>
      <expectedResult>
        <condition type="textPresent">Pro</condition>
        <condition type="textPresent">EUR 249/month</condition>
        <condition type="textPresent">Unlimited calls included*</condition>
        <condition type="textPresent">5 phone numbers</condition>
        <condition type="textPresent">Multi-location support</condition>
        <condition type="textPresent">Priority 24/7 support</condition>
        <condition type="textPresent">Dedicated account manager</condition>
      </expectedResult>
    </step>

    <step id="3" type="verification">
      <action>Verify fair use policy note</action>
      <expectedResult>
        <condition type="textPresent">* Fair use policy: 1,500 calls/month cap</condition>
      </expectedResult>
    </step>

    <step id="4" type="interaction">
      <action>Click Get Started on Pro plan</action>
      <target selector="button" text="Get Started" plan="scale" />
      <expectedResult>
        <condition type="navigation">To login or Stripe checkout</condition>
      </expectedResult>
    </step>

    <step id="5" type="conditional">
      <action>Complete login if required</action>
      <condition>If redirected to /login</condition>
      <interaction>
        <step>Complete authentication</step>
      </interaction>
      <expectedResult>
        <condition type="redirectTo">Stripe checkout</condition>
      </expectedResult>
    </step>

    <step id="6" type="verification">
      <action>Verify Stripe checkout shows Pro plan</action>
      <expectedResult>
        <condition type="urlContains">checkout.stripe.com</condition>
        <condition type="textPresent">EUR 249.00</condition>
      </expectedResult>
    </step>

    <step id="7" type="interaction">
      <action>Complete payment with test card</action>
      <testData>
        <field name="cardNumber" value="${testCard}" />
        <field name="expiry" value="${testExpiry}" />
        <field name="cvc" value="${testCvc}" />
      </testData>
      <target selector="button" text="Pay" />
      <expectedResult>
        <condition type="paymentSuccess">true</condition>
        <condition type="redirectTo">/dashboard</condition>
      </expectedResult>
    </step>

    <step id="8" type="verification">
      <action>Verify Pro subscription activated</action>
      <url>${baseUrl}/dashboard/billing</url>
      <expectedResult>
        <condition type="textPresent">Pro</condition>
        <condition type="textPresent">Active</condition>
        <condition type="textPresent">EUR 249/mo</condition>
        <condition type="textPresent">Unlimited calls</condition>
        <condition type="textPresent">5 phone numbers</condition>
      </expectedResult>
    </step>
  </steps>

  <teardown>
    <step>
      <action>Cancel test subscription</action>
      <target type="api">POST /api/billing/test/cancel-subscription</target>
    </step>
  </teardown>

  <notes>
    <note>Pro plan includes unlimited calls with fair use policy</note>
    <note>1,500 calls/month cap applies</note>
    <note>Highest tier with all features</note>
  </notes>
</testFlow>
