<?xml version="1.0" encoding="UTF-8"?>
<testFlow id="growth_plan_checkout_flow" version="1.0">
  <metadata>
    <name>Growth Plan Checkout Flow</name>
    <description>Tests the complete checkout flow for the Growth plan at EUR 99/month</description>
    <priority>critical</priority>
    <estimatedDuration>4m</estimatedDuration>
    <tags>
      <tag>checkout</tag>
      <tag>stripe</tag>
      <tag>growth-plan</tag>
      <tag>eur</tag>
    </tags>
  </metadata>

  <prerequisites>
    <prerequisite>Stripe test mode enabled</prerequisite>
    <prerequisite>Payment links configured in environment</prerequisite>
  </prerequisites>

  <testData>
    <variable name="baseUrl" value="https://voicefleet.ai" />
    <variable name="planName" value="Growth" />
    <variable name="planPrice" value="99" />
    <variable name="perCallRate" value="0.45" />
    <variable name="testCard" value="4242424242424242" />
    <variable name="testExpiry" value="12/34" />
    <variable name="testCvc" value="123" />
  </testData>

  <steps>
    <step id="1" type="navigation">
      <action>Navigate to pricing section</action>
      <url>${baseUrl}/#pricing</url>
      <expectedResult>
        <condition type="elementVisible">Pricing cards</condition>
      </expectedResult>
    </step>

    <step id="2" type="verification">
      <action>Verify Growth plan is marked as Most Popular</action>
      <expectedResult>
        <condition type="elementVisible">Most Popular badge on Growth plan</condition>
        <condition type="cssClass">border-primary ring-2</condition>
      </expectedResult>
    </step>

    <step id="3" type="verification">
      <action>Verify Growth plan details</action>
      <expectedResult>
        <condition type="textPresent">Growth</condition>
        <condition type="textPresent">EUR 99/month</condition>
        <condition type="textPresent">+ EUR 0.45 per call</condition>
        <condition type="textPresent">2 phone numbers</condition>
        <condition type="textPresent">Appointment booking</condition>
        <condition type="textPresent">Calendar integration</condition>
        <condition type="textPresent">Analytics dashboard</condition>
      </expectedResult>
    </step>

    <step id="4" type="interaction">
      <action>Click Get Started on Growth plan</action>
      <target selector="button" text="Get Started" plan="growth" />
      <expectedResult>
        <condition type="navigation">To login or Stripe checkout</condition>
      </expectedResult>
    </step>

    <step id="5" type="conditional">
      <action>Complete login if required</action>
      <condition>If redirected to /login</condition>
      <interaction>
        <step>Complete authentication</step>
        <step>Wait for redirect to Stripe</step>
      </interaction>
      <expectedResult>
        <condition type="redirectTo">Stripe checkout</condition>
      </expectedResult>
    </step>

    <step id="6" type="verification">
      <action>Verify Stripe checkout shows Growth plan</action>
      <expectedResult>
        <condition type="urlContains">checkout.stripe.com</condition>
        <condition type="textPresent">EUR 99.00</condition>
        <condition type="elementVisible">Card input fields</condition>
      </expectedResult>
    </step>

    <step id="7" type="interaction">
      <action>Complete payment with test card</action>
      <testData>
        <field name="cardNumber" value="${testCard}" />
        <field name="expiry" value="${testExpiry}" />
        <field name="cvc" value="${testCvc}" />
      </testData>
      <target selector="button" text="Pay" />
      <expectedResult>
        <condition type="paymentSuccess">true</condition>
        <condition type="redirectTo">/dashboard</condition>
      </expectedResult>
    </step>

    <step id="8" type="verification">
      <action>Verify Growth subscription activated</action>
      <url>${baseUrl}/dashboard/billing</url>
      <expectedResult>
        <condition type="textPresent">Growth</condition>
        <condition type="textPresent">Active</condition>
        <condition type="textPresent">EUR 99/mo</condition>
        <condition type="textPresent">2 phone numbers</condition>
      </expectedResult>
    </step>
  </steps>

  <teardown>
    <step>
      <action>Cancel test subscription</action>
      <target type="api">POST /api/billing/test/cancel-subscription</target>
    </step>
  </teardown>

  <notes>
    <note>Growth plan is the most popular tier</note>
    <note>Includes appointment booking feature</note>
    <note>Lower per-call rate than Starter</note>
  </notes>
</testFlow>
